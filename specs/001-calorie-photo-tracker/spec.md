# Feature Specification: Трекер Калорий по Фотографии

**Feature Branch**: `001-calorie-photo-tracker`
**Created**: 2025-11-03
**Status**: Draft
**Input**: User description: "Нужно создать сайд приложение для определения каллорийности по фотографии. Пользователь может зайти на сайт авторизироваться с помощью Google Account или с помощью Email + Password (Аккаунт действителен только после подтверждения из письма). Загрузить фотографию с тарелкой, и получить список продуктов, их вес ( кол-во ) Каллорийность и БЖУ , вес возможно будет подредактировать, в случае если пользователь удавлетворен каллорийностью, сайт предлагает внести запись в его профиль в зависимости от времени суток предлагает куда (завтрк обед или ужен или перекус), так же у пользователя есть профиль в котором можно установить вес возврат пол, рост, на выбор набор удержание похудение или подсчет сахара, так же в профиле есть календарь который показывает сколько дней в месяце пользователь придерживался той каллорийности которую он выставляет в начале ( зависит от выбора режима )"

## Clarifications

### Session 2025-11-03

- Q: Какой метод хеширования паролей использовать для email/password аутентификации? → A: Использование bcrypt с солью для хеширования паролей (индустриальный стандарт)
- Q: Как долго хранить загруженные фотографии еды в системе? → A: 30 дней с автоматической очисткой через Vercel Blob lifecycle policies (баланс между функциональностью и затратами)
- Q: Что происходит с данными о приемах пищи после автоматического удаления фотографий? → A: Данные о приемах пищи (продукты, калории, БЖУ) сохраняются независимо от фото (история остается полной)
- Q: Какие минимальные требования к сложности пароля установить для email/password регистрации? → A: Минимум 8 символов с требованием хотя бы одной цифры и одной буквы (соответствует рекомендациям OWASP, баланс безопасности и UX)
- Q: Какой механизм верификации email использовать при регистрации? → A: Уникальная ссылка с токеном (UUID) с временем истечения 24 часа (индустриальный стандарт, баланс безопасности и UX)

## User Scenarios & Testing

### User Story 1 - Регистрация и Вход в Систему (Priority: P1)

Пользователь может зарегистрироваться в приложении используя Google аккаунт или email/пароль. При регистрации через email система отправляет письмо с подтверждением, и аккаунт становится активным только после подтверждения. После успешной регистрации пользователь получает доступ ко всем функциям приложения.

**Why this priority**: Это базовая функция, необходимая для идентификации пользователей и сохранения их данных. Без аутентификации невозможно персонализировать опыт и хранить историю приемов пищи.

**Independent Test**: Можно полностью протестировать, создав аккаунт через Google или email/пароль, подтвердив email (для второго варианта) и войдя в систему. Успех определяется возможностью войти и увидеть личный кабинет.

**Acceptance Scenarios**:

1. **Given** пользователь на странице регистрации, **When** пользователь нажимает "Войти через Google" и подтверждает доступ, **Then** пользователь автоматически входит в систему и перенаправляется на главную страницу
2. **Given** пользователь на странице регистрации, **When** пользователь вводит email, пароль и нажимает "Зарегистрироваться", **Then** система отправляет письмо с подтверждением на указанный email
3. **Given** пользователь получил письмо с подтверждением, **When** пользователь переходит по ссылке из письма, **Then** аккаунт активируется и пользователь перенаправляется на страницу входа с сообщением об успешной активации
4. **Given** пользователь с подтвержденным email, **When** пользователь вводит email и пароль и нажимает "Войти", **Then** пользователь входит в систему и видит главную страницу

---

### User Story 2 - Анализ Фотографии Еды (Priority: P2)

Пользователь загружает фотографию тарелки с едой, и система автоматически распознает продукты на изображении, определяет их вес/количество, рассчитывает калорийность и макронутриенты (белки, жиры, углеводы) для каждого продукта. Результаты отображаются в виде списка с детальной информацией по каждому продукту.

**Why this priority**: Это основная ценность приложения - автоматическое определение калорий по фото. Именно эта функция отличает приложение от простых калькуляторов калорий и делает процесс подсчета быстрым и удобным.

**Independent Test**: Можно протестировать, загрузив фотографию тарелки с едой и проверив, что система вернула список продуктов с их весом, калориями и БЖУ. Успех определяется получением осмысленных результатов анализа.

**Acceptance Scenarios**:

1. **Given** авторизованный пользователь на главной странице, **When** пользователь нажимает кнопку "Загрузить фото" и выбирает изображение тарелки с едой, **Then** система начинает обработку изображения и показывает индикатор загрузки
2. **Given** система обрабатывает загруженное фото, **When** анализ завершается успешно, **Then** система отображает список распознанных продуктов с указанием названия, веса/количества, калорий и БЖУ для каждого продукта
3. **Given** на фото несколько продуктов, **When** система завершает анализ, **Then** для каждого распознанного продукта отображается отдельная карточка с детальной информацией
4. **Given** загруженное фото низкого качества или без еды, **When** система не может распознать продукты, **Then** пользователь видит сообщение с рекомендацией загрузить более качественное фото

---

### User Story 3 - Редактирование и Сохранение Приема Пищи (Priority: P3)

После получения результатов анализа пользователь может отредактировать вес/количество любого продукта, и система автоматически пересчитывает калорийность и БЖУ. Когда пользователь удовлетворен результатами, он может сохранить прием пищи в свой профиль. Система автоматически предлагает категорию приема пищи (завтрак, обед, ужин или перекус) на основе текущего времени суток.

**Why this priority**: Эта функция повышает точность учета калорий, так как автоматическое распознавание может быть неточным. Возможность корректировки данных критична для пользователей, которым важна точность подсчета.

**Independent Test**: Можно протестировать, изменив вес продукта в результатах анализа, проверив пересчет калорий, и сохранив прием пищи в профиль. Успех определяется правильным пересчетом и успешным сохранением данных.

**Acceptance Scenarios**:

1. **Given** пользователь видит результаты анализа фото, **When** пользователь нажимает на поле с весом продукта и вводит новое значение, **Then** система автоматически пересчитывает калории и БЖУ для этого продукта и обновляет общую сумму
2. **Given** пользователь отредактировал данные и хочет сохранить прием пищи, **When** пользователь нажимает кнопку "Сохранить", **Then** система показывает диалог выбора типа приема пищи с предложением по умолчанию на основе текущего времени (утро: завтрак, день: обед, вечер: ужин, промежутки: перекус)
3. **Given** пользователь в диалоге выбора типа приема пищи, **When** пользователь выбирает категорию и подтверждает сохранение, **Then** прием пищи сохраняется в профиль пользователя с указанной категорией и текущей датой/временем
4. **Given** пользователь сохранил прием пищи, **When** сохранение завершается успешно, **Then** пользователь видит подтверждающее сообщение и может начать новый анализ или перейти в профиль

---

### User Story 4 - Управление Профилем и Целями (Priority: P4)

Пользователь может настроить свой профиль, указав базовые параметры: вес, возраст, пол и рост. На основе этих данных и выбранной цели (набор массы, удержание веса, похудение или контроль сахара) система рассчитывает рекомендуемую дневную калорийность. Пользователь может в любой момент изменить свои данные или выбранную цель.

**Why this priority**: Персонализация является важной частью приложения для отслеживания питания. Она позволяет системе давать релевантные рекомендации и отслеживать прогресс относительно индивидуальных целей пользователя.

**Independent Test**: Можно протестировать, заполнив профиль базовыми параметрами, выбрав цель и проверив, что система рассчитала рекомендуемую калорийность. Успех определяется сохранением данных и отображением персонализированных рекомендаций.

**Acceptance Scenarios**:

1. **Given** пользователь впервые вошел в систему, **When** пользователь переходит в раздел "Профиль", **Then** система показывает форму с полями: вес (кг), возраст (лет), пол (мужской/женский), рост (см)
2. **Given** пользователь заполняет форму профиля, **When** пользователь указывает все параметры и нажимает "Далее", **Then** система показывает экран выбора цели с опциями: "Набор массы", "Удержание веса", "Похудение", "Контроль сахара"
3. **Given** пользователь выбрал цель, **When** пользователь подтверждает выбор, **Then** система рассчитывает рекомендуемую дневную калорийность на основе параметров профиля и выбранной цели, и отображает ее пользователю
4. **Given** пользователь с заполненным профилем, **When** пользователь изменяет любой параметр или цель, **Then** система пересчитывает рекомендуемую калорийность и сохраняет обновленные данные

---

### User Story 5 - Календарь Прогресса (Priority: P5)

Пользователь может просматривать календарь, который визуально показывает дни месяца, в которые пользователь придерживался своей целевой калорийности. Это помогает отслеживать консистентность и мотивирует продолжать следовать плану питания.

**Why this priority**: Визуализация прогресса является мощным инструментом мотивации. Календарь помогает пользователям видеть свои достижения и паттерны, что повышает вовлеченность и помогает достигать долгосрочных целей.

**Independent Test**: Можно протестировать, просмотрев календарь после нескольких дней использования приложения и проверив, что дни с соблюдением калорийности отмечены визуально. Успех определяется корректным отображением истории.

**Acceptance Scenarios**:

1. **Given** пользователь с историей приемов пищи, **When** пользователь открывает раздел "Календарь", **Then** система отображает календарь текущего месяца с визуальными индикаторами для дней, когда была активность
2. **Given** пользователь просматривает календарь, **When** пользователь нажимает на день с активностью, **Then** система показывает детальную информацию за этот день: все приемы пищи, общая калорийность, отклонение от целевой калорийности
3. **Given** день в календаре, **When** общая калорийность за день находится в пределах ±10% от целевой, **Then** этот день отмечается зеленым цветом как "цель достигнута"
4. **Given** день в календаре, **When** общая калорийность за день значительно отличается от целевой (>10%), **Then** этот день отмечается серым цветом как "цель не достигнута"
5. **Given** пользователь просматривает календарь, **When** пользователь переключается на предыдущий/следующий месяц, **Then** система загружает и отображает данные за выбранный месяц

---

### Edge Cases

- **Что происходит, когда на фото нет еды?** Система должна распознать это и показать сообщение с просьбой загрузить фото с едой
- **Что если фото слишком размытое или темное?** Система должна попытаться проанализировать, но если качество недостаточное, показать предупреждение о низком качестве и предложить загрузить другое фото
- **Что если система не может распознать какой-то продукт?** Пользователь должен иметь возможность добавить продукт вручную с указанием названия, веса и выбором из базы данных продуктов
- **Что происходит с неподтвержденным email аккаунтом?** Пользователь не может войти в систему до подтверждения email. При попытке входа система показывает сообщение о необходимости подтверждения с возможностью повторной отправки письма
- **Что если пользователь не заполнил профиль?** Система может работать без профиля, но не сможет давать персонализированные рекомендации по калорийности и отслеживать прогресс к целям
- **Что если пользователь загружает очень большой файл?** Система должна ограничивать размер файла (например, максимум 10 МБ) и показывать сообщение об ошибке при превышении лимита
- **Что происходит при потере интернет-соединения во время загрузки?** Система должна показать сообщение об ошибке сети и предложить повторить попытку
- **Что если пользователь пытается сохранить прием пищи без продуктов?** Система должна запретить сохранение и показать сообщение о необходимости добавить хотя бы один продукт
- **Что происходит если email-сервис (Resend) недоступен при регистрации?** Регистрация помещается в очередь retry с экспоненциальной задержкой (1 мин, 5 мин, 15 мин, максимум 3 попытки). Если все попытки неуспешны, пользователь видит сообщение "Не удалось отправить письмо подтверждения" с возможностью повторной отправки через профиль

## Requirements

### Functional Requirements

- **FR-001**: Система ДОЛЖНА поддерживать аутентификацию через Google OAuth
- **FR-002**: Система ДОЛЖНА поддерживать регистрацию через email и пароль с обязательным подтверждением email
- **FR-002a**: Система ДОЛЖНА хешировать пароли пользователей используя bcrypt с cost factor 10 (bcrypt автоматически генерирует уникальную соль для каждого пароля при хешировании)
- **FR-002b**: Система ДОЛЖНА валидировать пароли при регистрации: минимум 8 символов, обязательное наличие хотя бы одной цифры и одной буквы
- **FR-003**: Система ДОЛЖНА отправлять письмо с подтверждением на указанный email при регистрации
- **FR-003a**: Письмо с подтверждением ДОЛЖНО содержать уникальную ссылку с токеном (UUID), действительную в течение 24 часов с момента генерации
- **FR-004**: Пользователи ДОЛЖНЫ иметь возможность входить в систему только после подтверждения email (для регистрации через email/пароль)
- **FR-005**: Система ДОЛЖНА принимать изображения для анализа со следующими ограничениями:
  - Поддерживаемые форматы: JPG, PNG, HEIC
  - Максимальный размер файла: 10 МБ
- **FR-005a**: Система ДОЛЖНА хранить загруженные фотографии еды в течение 30 дней с момента загрузки, после чего автоматически удалять их для оптимизации затрат на хранение
- **FR-005b**: Автоматическое удаление фотографий НЕ ДОЛЖНО влиять на сохраненные данные о приемах пищи - все продукты, калории и БЖУ должны оставаться в истории пользователя
- **FR-006**: Система ДОЛЖНА распознавать продукты питания на загруженных изображениях с точностью не менее 75% для распространенных продуктов (Top-1 accuracy: правильная идентификация продукта в первом результате распознавания, см. SC-004). **Распространенные продукты** определяются как ~500 наиболее часто фотографируемых продуктов питания (см. research.md §R007 - local seeded database): базовые злаки (рис, гречка, макароны), мясо (курица, говядина, свинина), овощи (помидоры, огурцы, капуста), фрукты (яблоки, бананы, апельсины), молочные продукты (молоко, сыр, йогурт), яйца, хлеб, распространенные готовые блюда
- **FR-007**: Система ДОЛЖНА определять приблизительный вес/количество каждого распознанного продукта (допустимая погрешность ±25% для дальнейшей корректировки пользователем). **Обоснование погрешности**: Vision models (Claude Haiku/Sonnet) обеспечивают точность определения веса ±20-30% на основе визуального анализа (research.md §R005:398). Порог ±25% выбран как медиана этого диапазона. Пользователь может скорректировать вес вручную (FR-010) для точного учета калорий
- **FR-008**: Система ДОЛЖНА рассчитывать калорийность для каждого распознанного продукта на основе его веса
- **FR-009**: Система ДОЛЖНА рассчитывать макронутриенты (белки, жиры, углеводы) для каждого распознанного продукта
- **FR-010**: Пользователи ДОЛЖНЫ иметь возможность редактировать вес/количество любого продукта в результатах анализа
- **FR-011**: Система ДОЛЖНА автоматически пересчитывать калории и БЖУ при изменении веса продукта
- **FR-012**: Система ДОЛЖНА предлагать категорию приема пищи на основе текущего времени пользователя (client-side timezone, определяется на момент сохранения): утро (6:00-11:00) - завтрак, день (11:00-16:00) - обед, вечер (16:00-21:00) - ужин, остальное время - перекус. Timezone фиксируется в момент создания приема пищи и не меняется при последующих изменениях пояса пользователя
- **FR-013**: Пользователи ДОЛЖНЫ иметь возможность выбрать категорию приема пищи вручную (завтрак, обед, ужин, перекус)
- **FR-014**: Система ДОЛЖНА сохранять прием пищи в профиль пользователя с указанием даты, времени, категории и всех продуктов
- **FR-015**: Пользователи ДОЛЖНЫ иметь возможность указать в профиле: вес (кг), возраст (лет), пол, рост (см)
- **FR-016**: Пользователи ДОЛЖНЫ иметь возможность выбрать цель: набор массы, удержание веса, похудение, контроль сахара
- **FR-017**: Система ДОЛЖНА рассчитывать рекомендуемую дневную калорийность на основе параметров профиля и выбранной цели используя формулу Миффлина-Сан Жеора (BMR) с корректировкой на цель. **Детали реализации**: см. research.md §R006 (строки 480-599) - полная формула, коэффициенты активности (1.2 для sedentary), goal multipliers (+15% bulk, 0% maintain, -15% cut, 0% sugar control)
- **FR-018**: Система ДОЛЖНА отображать календарь с визуальными индикаторами дней, когда пользователь записывал приемы пищи
- **FR-019**: Система ДОЛЖНА определять соблюдение целевой калорийности как нахождение в пределах ±10% от рекомендуемого значения
- **FR-020**: Календарь ДОЛЖЕН показывать детальную информацию за выбранный день при клике на него
- **FR-021**: Система ДОЛЖНА показывать индикатор загрузки во время обработки изображения
- **FR-022**: Пользователи ДОЛЖНЫ иметь возможность добавлять продукты вручную, если система не распознала их автоматически. При ручном добавлении:
  - Пользователь вводит название продукта
  - Система выполняет поиск в USDA FoodData Central API
  - Пользователь выбирает продукт из результатов поиска (БЖУ подставляются автоматически)
  - Если продукта нет в базе USDA, пользователь может ввести БЖУ вручную
  - **Fallback при недоступности USDA API**: Если USDA API недоступен (network error, 500, timeout), система должна: (1) показать уведомление "База данных продуктов временно недоступна", (2) предложить ввести название продукта и БЖУ вручную, (3) сохранить продукт с пометкой "Добавлено вручную" (addedManually=true в БД)

### Key Entities

- **Пользователь (User)**: Зарегистрированный пользователь системы. Ключевые атрибуты: email, метод аутентификации (Google/Email), статус подтверждения email (emailVerified), хешированный пароль (hashedPassword, для email-аутентификации, bcrypt с cost factor 10), токен верификации email (verificationToken, UUID, срок действия 24 часа через tokenExpiresAt), дата регистрации (createdAt). Детали: data-model.md §User
- **Профиль (UserProfile)**: Персональные данные пользователя. Атрибуты: вес, возраст, пол, рост, выбранная цель, рекомендуемая калорийность. Связь: один профиль принадлежит одному пользователю
- **Фотография Еды (FoodPhoto)**: Загруженное изображение тарелки с едой. Атрибуты: URL изображения, дата загрузки, дата автоматического удаления (загрузка + 30 дней), статус обработки. Связь: принадлежит пользователю
- **Продукт (FoodItem)**: Распознанный или добавленный вручную продукт питания. Атрибуты: название, вес/количество, калории на 100г, белки на 100г, жиры на 100г, углеводы на 100г, способ добавления (автоматически/вручную)
- **Прием Пищи (Meal)**: Сохраненная запись о приеме пищи. Атрибуты: дата, время, категория (завтрак/обед/ужин/перекус), общая калорийность, общие БЖУ. Связь: принадлежит пользователю, содержит несколько продуктов, может быть связан с фотографией (опциональная связь - прием пищи остается после удаления фото)
- **Дневная Запись (DailyLog)**: Агрегированные данные за день. Атрибуты: дата, общая калорийность за день, общие БЖУ, отклонение от целевой калорийности, статус достижения цели. Связь: принадлежит пользователю, агрегирует приемы пищи за день

### Assumptions

- Используется OpenRouter API с моделью anthropic/claude-3-haiku для распознавания продуктов на изображениях (решение задокументировано в research.md §R005). Для production может использоваться anthropic/claude-3-sonnet для повышения точности
- Используется USDA FoodData Central API для получения информации о калорийности и БЖУ продуктов (бесплатный API, решение задокументировано в research.md §R007)
- Расчет рекомендуемой калорийности выполняется по стандартным формулам (например, формула Миффлина-Сан Жеора)
- Пользователи имеют стабильное интернет-соединение для загрузки фотографий и получения результатов
- Система предполагает, что пользователи загружают фотографии своей еды, а не случайные изображения
- Email-сервис для отправки писем с подтверждением настроен и работает надежно
- Хранение данных пользователей соответствует требованиям защиты персональных данных

## Success Criteria

### Measurable Outcomes

- **SC-001**: Пользователи могут завершить регистрацию через Google за менее чем 30 секунд
- **SC-002**: Пользователи могут завершить регистрацию через email/пароль (включая подтверждение email) за менее чем 3 минут
- **SC-003**: Система обрабатывает и возвращает результаты анализа фотографии за менее чем 10 секунд для изображений стандартного размера (до 5 МБ)
- **SC-004**: Точность распознавания распространенных продуктов питания составляет не менее 75% (правильная идентификация продукта)
- **SC-005**: 90% пользователей успешно загружают фото и получают результаты анализа с первой попытки
- **SC-006**: Пользователи могут отредактировать вес продукта и увидеть обновленную калорийность мгновенно (менее 1 секунды)
- **SC-007**: Пользователи могут сохранить прием пищи в свой профиль за менее чем 5 кликов
- **SC-008**: 85% пользователей заполняют свой профиль полностью (все обязательные поля) в течение первых трех использований приложения
- **SC-009**: Календарь загружается и отображает данные за месяц за менее чем 2 секунды
- **SC-010**: Пользователи, использующие приложение регулярно (более 5 дней в неделю), сообщают о повышении осознанности в питании на 60% (на основе опросов)
- **SC-011**: Уровень удержания пользователей (retention rate) составляет не менее 40% через 30 дней после регистрации
- **SC-012**: 80% новых пользователей совершают свой первый анализ фотографии в течение 5 минут после регистрации
